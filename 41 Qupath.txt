import qupath.ext.stardist.StarDist2D
import qupath.lib.gui.dialogs.Dialogs
import qupath.lib.scripting.QP
import qupath.lib.images.servers.ImageServer
import qupath.lib.images.servers.bioformats.BioFormatsImageServer
import qupath.lib.images.servers.TransformedServerBuilder
import qupath.lib.gui.viewer.QuPathViewer
import java.awt.image.BufferedImage
import java.io.File
import javax.imageio.ImageIO
import qupath.lib.objects.PathAnnotationObject
import java.nio.file.Files
import java.nio.file.Path
import java.nio.file.Paths

def pathObjects = QP.getSelectedObjects()

def image = getCurrentImageData()
def imageServer = getCurrentServer()
def list = ['DAPI','CD14','CD79a','FOXP3','CD38','CD31','PD-1','Granzyme B','CD20','PD-L1',
'IFNG','ATP1A1','HIF1A','IgA','Hepar1','CD3e','Ki67','Pan-Cytokeratin','CD206','MPO','EpCAM',
'Vimentin','CD8','IgG','CD68','Podoplanin','SMA','CD45','CD45RO','S100A8_9','HLA-DR',
'CD163','CD4']

for (int j = 0;j<200;j++) {
    Annotation = pathObjects[j]
    print Annotation
    def folderPath = "E:\\01-TLS\\13-Cohort\\ZhongShan Cohort\\Analysis-2\\task2\\01-fov\\" + Annotation
    Path folder = Paths.get(folderPath)
    Files.createDirectories(folder)
    for (int i = 0;i<33;i++) {
        channel = list[i]
        def outputPath = folderPath+'\\'+channel+ '.tif'
        def roi = Annotation.getROI()
        def singleChannel = new TransformedServerBuilder(image.getServer())
                .extractChannels(channel)
                .build()
        def regionRequest = RegionRequest.createInstance(singleChannel.getPath(),1, roi)
        def roiImage = singleChannel.readRegion(regionRequest)
        def outputFile = new File(outputPath)
        writeImage(roiImage,outputPath)
        println("ROI图像已保存为TIFF文件：$outputPath")
}

}